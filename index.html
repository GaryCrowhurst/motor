<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Engine Escape</title>
  <style>
    :root{
      /* Fresh "workshop he</div>at" theme */
      --bg:#0b0c10;         /* app background */
      --panel:#14161b;      /* card/panel */
      --ink:#f8fafc;        /* text */
      --muted:#94a3b8;      /* secondary text */
      --accent:#ff8a3d;     /* primary accent (amber) */
      --good:#4ade80;       /* success */
      --bad:#f43f5e;        /* error */
      --warn:#f59e0b;       /* warning */
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      /* layered background: warm glow + subtle grid */
      background:
        radial-gradient(1200px 800px at 85% -10%, rgba(255,138,61,.25) 0%, rgba(255,138,61,0) 50%),
        radial-gradient(1000px 700px at 10% 10%, rgba(255,138,61,.15) 0%, rgba(255,138,61,0) 60%),
        repeating-linear-gradient(90deg, rgba(255,255,255,.03) 0 1px, transparent 1px 60px),
        repeating-linear-gradient(0deg, rgba(255,255,255,.03) 0 1px, transparent 1px 60px),
        linear-gradient(180deg,#0b0c10,#0b0c10);
      color:var(--ink);
      font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;
      min-height:100vh
    }
    h1,h2,h3{line-height:1.1;margin:0 0 .35rem}
    h1{font-size:clamp(24px,3vw,36px)}
    h2{font-size:clamp(18px,2.2vw,24px);color:#dce3ff}
    .wrap{max-width:1200px;margin:auto;padding:20px}
    .grid{display:grid;gap:16px}
    .cols{grid-template-columns:repeat(auto-fit,minmax(300px,1fr))}
    
    .panel{
      background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(0,0,0,.08));
      border:1px solid rgba(255,255,255,.08);
      border-radius:14px;
      padding:20px;
      box-shadow:0 10px 30px rgba(0,0,0,.35);
      transition:transform .25s ease, box-shadow .25s ease, border-color .25s ease;
    }
    
    .panel:hover{transform:translateY(-2px);box-shadow:0 15px 50px rgba(0,0,0,.4)}
    
    .task-card{position:relative;overflow:hidden;padding-bottom:48px}
    .task-card::before{
      content:'';position:absolute;top:0;left:0;right:0;height:3px;
      background:linear-gradient(90deg,transparent,var(--accent),transparent);
      opacity:0;transition:opacity .3s;
    }
    .task-card:hover::before{opacity:1}
  .task-card.solved{border-color:var(--good);background:linear-gradient(180deg,rgba(74,222,128,.09),rgba(0,0,0,.06))}
    .task-card.solved::after{
      content:'âœ“';position:absolute;top:12px;left:12px;
      width:32px;height:32px;border-radius:50%;
  background:var(--good);color:#0b0c10;
      display:grid;place-items:center;font-weight:900;font-size:20px;
      animation:pop .5s cubic-bezier(.68,-0.55,.265,1.55);
    }
    
    @keyframes pop{from{transform:scale(0) rotate(-180deg)}to{transform:scale(1) rotate(0)}}
    @keyframes slideIn{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}
    @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
    @keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-10px)}75%{transform:translateX(10px)}}
    
    .btn{
      cursor:pointer;border:none;padding:.75rem 1.25rem;border-radius:12px;
      background:linear-gradient(135deg,#ffb653,#ff7a59);color:#111;
      font-weight:800;letter-spacing:.3px;font-size:15px;
      transition:all .2s;box-shadow:0 4px 12px rgba(255,138,61,.35);
      text-shadow:0 1px 0 rgba(255,255,255,.35);
    }
    .btn:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 8px 24px rgba(255,138,61,.5)}
    .btn:active:not(:disabled){transform:translateY(0)}
    .btn.secondary{background:linear-gradient(135deg,#252a33,#181c23);box-shadow:0 4px 12px rgba(0,0,0,.4);color:var(--ink);text-shadow:none}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,.22);box-shadow:none;color:var(--ink);text-shadow:none}
    .btn.ghost:hover:not(:disabled){background:rgba(255,255,255,.06);border-color:rgba(255,255,255,.35)}
    .btn:disabled{opacity:.4;cursor:not-allowed;transform:none!important}
    
    .badge{
      display:inline-flex;gap:.5ch;align-items:center;padding:.4rem .7rem;
      border-radius:999px;background:#171a20;
      border:1px solid rgba(255,255,255,.12);font-size:13px;color:var(--muted);
      box-shadow:0 2px 8px rgba(0,0,0,.25);
    }
    
    .hint{font-size:14px;color:var(--muted);animation:slideIn .3s ease}
    
    input,select{
      background:#13161c;color:var(--ink);
      border:1px solid rgba(255,255,255,.18);border-radius:10px;
      padding:.7rem .8rem;font-size:15px;transition:all .2s;
    }
    input:focus,select:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(255,138,61,.15)}
    input[type="number"]{width:140px}
    input.error{border-color:var(--bad);animation:shake .3s}
    input.input-ok{border-color:var(--good);background:rgba(61,227,135,.06);box-shadow:0 4px 14px rgba(61,227,135,.06)}
    
    .ok{color:var(--good);font-weight:600}
    .no{color:var(--bad);font-weight:600}
    .warn{color:var(--warn);font-weight:600}
    
    .progress{
      height:12px;background:#12141a;border-radius:999px;overflow:hidden;
      border:1px solid rgba(255,255,255,.18);position:relative;
    }
    .progress>i{
      display:block;height:100%;
      background:linear-gradient(90deg,#ffb653,#ff8a3d,#4ade80);
      width:0%;transition:width .5s cubic-bezier(.68,-0.55,.265,1.55);
      box-shadow:0 0 10px rgba(255,138,61,.45);
    }
    
    .mono{font-family:ui-monospace,SFMono-Regular,Consolas,"Liberation Mono",Menlo,monospace}
    
    .token{
      position:absolute;right:14px;bottom:14px;
      display:inline-flex;align-items:center;gap:.4rem;padding:.35rem .65rem;
      border-radius:999px;border:2px dashed rgba(255,255,255,.3);
      font-size:13px;background:rgba(255,138,61,.12);font-weight:700;
      backdrop-filter:blur(8px);
    }
    
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    
    .car-diagram{
      border:2px solid rgba(255,255,255,.18);border-radius:14px;padding:20px;
      background:#12151b;text-align:center;transition:all .2s;
    }
    .car-diagram:hover{transform:scale(1.02)}
    
    dialog{
      border:none;border-radius:18px;
      background:linear-gradient(180deg,#171b23,#11151b);
      color:var(--ink);max-width:700px;padding:32px;
      box-shadow:0 20px 60px rgba(0,0,0,.7);
    }
  dialog::backdrop{background:rgba(0,0,0,.75);backdrop-filter:blur(4px)}
  .overflow-hidden{overflow:hidden}

  /* Video overlay */
  #videoOverlay{position:fixed;inset:0;display:none;background:rgba(0,0,0,.75);backdrop-filter:blur(4px);z-index:3000}
  #videoOverlay.open{display:grid;place-items:center}
  .video-box{width:min(100vw,calc(90dvh * 16 / 9));height:min(90dvh,calc(100vw * 9 / 16));margin:auto}
  .video-frame{width:100%;height:100%;border:0;border-radius:12px;background:#000}
  #closeVideoBtn{position:absolute;top:16px;right:16px;z-index:2}
    .dialog-actions{display:flex;justify-content:flex-end;margin-top:12px}
    
    .tiny{font-size:12px;color:var(--muted);line-height:1.5}
    
    .confetti{
      position:fixed;width:10px;height:10px;pointer-events:none;
      animation:confettiFall 3s linear forwards;z-index:1000;
    }
    @keyframes confettiFall{
      to{transform:translateY(100vh) rotate(720deg);opacity:0}
    }
    
    .header-badge{
      background:linear-gradient(135deg,rgba(255,138,61,.18),rgba(74,222,128,.14));
      border:2px solid rgba(255,138,61,.35);padding:.5rem 1rem;
      border-radius:12px;font-weight:600;
    }
    
    details{margin-top:20px}
    summary{cursor:pointer;padding:12px;background:rgba(255,255,255,.03);border-radius:10px;font-weight:600;user-select:none}
    summary:hover{background:rgba(255,255,255,.06)}
    
    .lockout-overlay{
      position:fixed;inset:0;background:rgba(0,0,0,.9);backdrop-filter:blur(8px);
      display:grid;place-items:center;z-index:2000;animation:slideIn .3s;
    }
    .lockout-box{
      background:linear-gradient(180deg,#2a1416,#170c0d);
      border:2px solid var(--bad);border-radius:20px;padding:40px;
      max-width:500px;text-align:center;box-shadow:0 20px 80px rgba(244,63,94,.35);
    }
    .lockout-timer{font-size:72px;font-weight:900;color:var(--bad);font-family:monospace;margin:20px 0}
    
    .penalty-badge{
      background:rgba(255,106,122,.15);border:2px solid var(--bad);
      padding:.3rem .6rem;border-radius:999px;font-size:12px;font-weight:700;
      color:var(--bad);display:inline-flex;align-items:center;gap:.3rem;
    }

    /* Task 15 specific styles */
    .t15-container{
      display:grid;
      grid-template-columns:minmax(120px,1fr) minmax(300px,2fr) minmax(120px,1fr);
      gap:20px;
      margin-top:16px;
    }
    .t15-column{
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .t15-column label{
      font-size:14px;
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .t15-column input{
      width:100%;
      font-size:14px;
      padding:.6rem;
    }
    .t15-center{
      display:flex;
      flex-direction:column;
      align-items:center;
    }
    .t15-diagram{
      border-radius:10px;
      overflow:hidden;
      border:2px solid rgba(255,255,255,.18);
      background:rgba(0,0,0,.28);
      max-width:500px;
    }
    .t15-diagram img{
      width:100%;
      display:block;
    }
    
    @media(max-width:1024px){
      .t15-container{
        grid-template-columns:1fr;
        gap:16px;
      }
      .t15-center{
        order:-1;
      }
    }

    @media(max-width:768px){
      .wrap{padding:16px}
      h1{font-size:22px}
      h2{font-size:18px}
      .cols{grid-template-columns:1fr}
      .lockout-timer{font-size:56px}
      .panel{padding:16px}
      .task-card{padding-bottom:40px}
      .btn{padding:.65rem 1rem;font-size:14px}
      input,select{font-size:14px;padding:.6rem .7rem}
      .car-diagram{padding:12px}
      .header-badge{padding:.4rem .8rem;font-size:12px}
      .badge{font-size:12px;padding:.3rem .6rem}
      dialog{padding:24px;max-width:90vw}
      .t15-column label{font-size:13px}
      .t15-column input{font-size:13px}
      .task-card[style*="grid-column:span"]{
        grid-column:1 !important;
      }
    }

    @media(max-width:480px){
      .wrap{padding:12px}
      h1{font-size:20px}
      h2{font-size:16px}
      .panel{padding:12px}
      .btn{padding:.55rem .85rem;font-size:13px}
      input,select{font-size:13px;padding:.5rem .6rem}
      input[type="number"]{width:120px}
      .row{gap:8px}
      .grid{gap:12px}
      .token{font-size:11px;padding:.3rem .5rem}
      .lockout-timer{font-size:48px}
      .lockout-box{padding:24px}
    }
  </style>
</head>
<body>
  <div class="wrap grid" style="gap:24px">
    <header class="panel grid" style="gap:12px">
      <div class="row" style="justify-content:space-between;flex-wrap:wrap">
        <div>
          <h1>ï¿½â„ï¸ Engine Escape</h1>
          <div class="badge" style="margin-top:8px">
            <span style="font-size:16px">ğŸ› ï¸</span>
            <span>Cycles, Heat Transfer, and Diagnostics</span>
          </div>
        </div>
        <button class="btn ghost" id="openGuide">ğŸ“– Reference Guide</button>
      </div>
      <p class="hint" style="max-width:900px">Solve all tasks to collect <b>6 OTP digits</b>. Solve the final riddle to unlock the code. <span class="warn">Warning: Wrong answers add 10-second time penalties!</span></p>
      <div class="progress"><i id="bar"></i></div>
      <div class="row" style="gap:12px;flex-wrap:wrap">
        <span class="badge header-badge">Tasks: <b class="mono" id="solved">0/15</b></span>
        <span class="badge header-badge">OTP Collected: <b class="mono" id="otp" style="letter-spacing:2px">______</b></span>
        <span class="badge header-badge" id="timerBadge">â±ï¸ <b class="mono" id="clock">00:00</b></span>
        <span class="penalty-badge" id="penaltyBadge" style="display:none">âš ï¸ Penalties: <b id="penalties">0</b></span>
        <button class="btn ghost" id="soundToggle" style="padding:.5rem .75rem">ğŸ”Š</button>
      </div>
    </header>

    <section class="grid cols" id="tasks">

      <!-- TASK 1 -->
      <article class="panel task-card" data-task="t1" data-token="3">
        <h2>Task 1 â€” Engine's Dance</h2>
        <p>The engine performs a four-step dance. Each emoji tells a story - decode the correct sequence!</p>
        <div class="grid" style="gap:8px">
          <label><b>1.</b> <select id="t1a"><option value="">â€” choose â€”</option><option value="Combustion">ğŸ’¥</option><option value="Exhaust">ğŸŒ«ï¸</option><option value="Induction">ğŸ’¨</option><option value="Compression">ğŸ”©</option></select></label>
          <label><b>2.</b> <select id="t1b"><option value="">â€” choose â€”</option><option value="Exhaust">ğŸŒ«ï¸</option><option value="Compression">ğŸ”©</option><option value="Combustion">ğŸ’¥</option><option value="Induction">ğŸ’¨</option></select></label>
          <label><b>3.</b> <select id="t1c"><option value="">â€” choose â€”</option><option value="Compression">ğŸ”©</option><option value="Induction">ğŸ’¨</option><option value="Exhaust">ğŸŒ«ï¸</option><option value="Combustion">ğŸ’¥</option></select></label>
          <label><b>4.</b> <select id="t1d"><option value="">â€” choose â€”</option><option value="Induction">ğŸ’¨</option><option value="Combustion">ğŸ’¥</option><option value="Compression">ğŸ”©</option><option value="Exhaust">ğŸŒ«ï¸</option></select></label>
        </div>
        <div class="row" style="margin-top:12px">
          <button class="btn" data-check="t1">Submit</button>
          <button class="btn ghost" data-hint="t1">ğŸ’¡ Hint</button>
        </div>
        <div class="hint" id="t1msg" style="margin-top:8px"></div>
        <div class="token">ğŸ« <b>3</b></div>
      </article>

      <!-- TASK 2 -->
      <article class="panel task-card" data-task="t2" data-token="7">
        <h2>Task 2 â€” Component Functions</h2>
        <p>Match each component to its primary function.</p>
        <div class="grid" style="grid-template-columns:1fr 1.2fr;gap:16px">
          <div style="padding:12px;background:rgba(255,255,255,.02);border-radius:10px">
            <div style="margin:8px 0"><b>A.</b> Piston</div>
            <div style="margin:8px 0"><b>B.</b> Spark Plug</div>
            <div style="margin:8px 0"><b>C.</b> Intake Valve</div>
            <div style="margin:8px 0"><b>D.</b> Crankshaft</div>
          </div>
          <div class="grid" style="gap:8px">
            <label><b>1.</b> Converts linear to rotary motion
              <select id="t2_1"><option value="">â€”</option><option>A</option><option>B</option><option>C</option><option>D</option></select>
            </label>
            <label><b>2.</b> Controls air-fuel mixture entry
              <select id="t2_2"><option value="">â€”</option><option>A</option><option>B</option><option>C</option><option>D</option></select>
            </label>
            <label><b>3.</b> Initiates combustion event
              <select id="t2_3"><option value="">â€”</option><option>A</option><option>B</option><option>C</option><option>D</option></select>
            </label>
            <label><b>4.</b> Reciprocates in cylinder
              <select id="t2_4"><option value="">â€”</option><option>A</option><option>B</option><option>C</option><option>D</option></select>
            </label>
          </div>
        </div>
        <div class="row" style="margin-top:12px">
          <button class="btn" data-check="t2">Submit</button>
          <button class="btn ghost" data-hint="t2">ğŸ’¡ Hint</button>
        </div>
        <div class="hint" id="t2msg" style="margin-top:8px"></div>
        <div class="token">ğŸ« <b>7</b></div>
      </article>

      <!-- TASK 3 -->
      <article class="panel task-card" data-task="t3" data-token="9">
        <h2>Task 3 â€” Unscramble Technical Terms</h2>
        <p>Unscramble each cycle stage:</p>
        <div class="grid" style="gap:10px">
          <label><b>TNICDOUIN</b> â†’ <input id="t3a" placeholder="stage name" style="width:100%"/></label>
          <label><b>ERSOMSPICON</b> â†’ <input id="t3b" placeholder="stage name" style="width:100%"/></label>
          <label><b>TBOMCNOISU</b> â†’ <input id="t3c" placeholder="stage name" style="width:100%"/></label>
          <label><b>XHUSTAE</b> â†’ <input id="t3d" placeholder="stage name" style="width:100%"/></label>
        </div>
        <div class="row" style="margin-top:12px">
          <button class="btn" data-check="t3">Submit</button>
          <button class="btn ghost" data-hint="t3">ğŸ’¡ Hint</button>
        </div>
        <div class="hint" id="t3msg" style="margin-top:8px"></div>
        <div class="token">ğŸ« <b>9</b></div>
      </article>

      <!-- TASK 4 -->
      <article class="panel task-card" data-task="t4" data-token="1">
        <h2>Task 4 â€” Historical Context</h2>
        <p>What year did Nikolaus Otto patent the 4-stroke engine principle?</p>
        <div class="row">
          <input id="t4" type="number" placeholder="YYYY" style="width:160px" />
          <button class="btn" data-check="t4">Submit</button>
          <button class="btn ghost" data-hint="t4">ğŸ’¡ Hint</button>
        </div>
        <div class="hint" id="t4msg" style="margin-top:8px"></div>
        <div class="token">ğŸ« <b>1</b></div>
      </article>

      <!-- TASK 5 -->
      <article class="panel task-card" data-task="t5" data-token="8">
        <h2>Task 5 â€” Diagnostic Analysis</h2>
        <p>Engine exhibits intermittent misfires under load. Which stroke is most likely compromised?</p>
        <div class="grid" style="gap:8px;margin-top:8px">
          <label style="padding:10px;background:rgba(255,255,255,.02);border-radius:8px;cursor:pointer;transition:.2s" class="radio-label">
            <input type="radio" name="t5" value="Induction"/> <b>Induction</b>
          </label>
          <label style="padding:10px;background:rgba(255,255,255,.02);border-radius:8px;cursor:pointer;transition:.2s" class="radio-label">
            <input type="radio" name="t5" value="Compression"/> <b>Compression</b>
          </label>
          <label style="padding:10px;background:rgba(255,255,255,.02);border-radius:8px;cursor:pointer;transition:.2s" class="radio-label">
            <input type="radio" name="t5" value="Combustion"/> <b>Combustion</b>
          </label>
          <label style="padding:10px;background:rgba(255,255,255,.02);border-radius:8px;cursor:pointer;transition:.2s" class="radio-label">
            <input type="radio" name="t5" value="Exhaust"/> <b>Exhaust</b>
          </label>
        </div>
        <div class="row" style="margin-top:12px">
          <button class="btn" data-check="t5">Submit</button>
          <button class="btn ghost" data-hint="t5">ğŸ’¡ Hint</button>
        </div>
        <div class="hint" id="t5msg" style="margin-top:8px"></div>
        <div class="token">ğŸ« <b>8</b></div>
      </article>

      <!-- TASK 6 -->
      <article class="panel task-card" data-task="t6" data-token="4">
        <h2>Task 6 â€” Firing Order Decoder</h2>
        <p>Standard inline-4 firing order is <span class="mono badge">1-3-4-2</span>. Calculate: sum of cylinder numbers.</p>
        <div class="row">
          <input id="t6code" class="mono" placeholder="sum" type="number" style="width:160px;font-size:18px;text-align:center"/>
          <button class="btn" data-check="t6">Submit</button>
          <button class="btn ghost" data-hint="t6">ğŸ’¡ Hint</button>
        </div>
        <div id="t6msg" class="hint" style="margin-top:10px"></div>
        <div class="token">ğŸ« <b>4</b></div>
      </article>

      <!-- TASK 7 -->
      <article class="panel task-card" data-task="t7" data-token="2">
        <h2>Task 7 â€” Colloquial Terminology</h2>
        <p>The 4-stroke cycle is sometimes called "Suck, Squeeze, Bang, Blow". Enter the <b>initials</b>.</p>
        <div class="row">
          <input id="t7" class="mono" placeholder="4 letters" maxlength="4" style="width:160px;font-size:18px;text-align:center;text-transform:uppercase"/>
          <button class="btn" data-check="t7">Submit</button>
          <button class="btn ghost" data-hint="t7">ğŸ’¡ Hint</button>
        </div>
        <div class="hint" id="t7msg" style="margin-top:8px"></div>
        <div class="token">ğŸ« <b>2</b></div>
      </article>

      <!-- TASK 8 - DRIVETRAIN MYSTERY -->
      <article class="panel task-card" data-task="t8" data-token="5" style="grid-column:span 2">
        <h2>Task 8 â€” Power Flow Patterns</h2>
        <p>Three vehicles, three distinct power flow patterns. Study the glowing wheels in each diagram. What's the secret code?</p>
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(100px,1fr));gap:20px;margin:16px 0">
          <div class="car-diagram">
            <svg viewBox="0 0 100 160" style="width:100px;margin:auto">
              <rect x="20" y="40" width="60" height="100" fill="none" stroke="currentColor" stroke-width="2"/>
              <circle cx="30" cy="60" r="10" fill="#6ae3ff" stroke="currentColor"/>
              <circle cx="70" cy="60" r="10" fill="#6ae3ff" stroke="currentColor"/>
              <circle cx="30" cy="120" r="10" fill="none" stroke="currentColor"/>
              <circle cx="70" cy="120" r="10" fill="none" stroke="currentColor"/>
              <text x="50" y="150" text-anchor="middle" fill="currentColor" font-size="14">1</text>
            </svg>
          </div>
          <div class="car-diagram">
            <svg viewBox="0 0 100 160" style="width:100px;margin:auto">
              <rect x="20" y="40" width="60" height="100" fill="none" stroke="currentColor" stroke-width="2"/>
              <circle cx="30" cy="60" r="10" fill="#6ae3ff" stroke="currentColor"/>
              <circle cx="70" cy="60" r="10" fill="#6ae3ff" stroke="currentColor"/>
              <circle cx="30" cy="120" r="10" fill="#6ae3ff" stroke="currentColor"/>
              <circle cx="70" cy="120" r="10" fill="#6ae3ff" stroke="currentColor"/>
              <text x="50" y="150" text-anchor="middle" fill="currentColor" font-size="14">2</text>
            </svg>
          </div>
          <div class="car-diagram">
            <svg viewBox="0 0 100 160" style="width:100px;margin:auto">
              <rect x="20" y="40" width="60" height="100" fill="none" stroke="currentColor" stroke-width="2"/>
              <circle cx="30" cy="60" r="10" fill="none" stroke="currentColor"/>
              <circle cx="70" cy="60" r="10" fill="none" stroke="currentColor"/>
              <circle cx="30" cy="120" r="10" fill="#6ae3ff" stroke="currentColor"/>
              <circle cx="70" cy="120" r="10" fill="#6ae3ff" stroke="currentColor"/>
              <text x="50" y="150" text-anchor="middle" fill="currentColor" font-size="14">3</text>
            </svg>
          </div>
        </div>
        <div class="row">
          <input id="t8" class="mono" placeholder="3 letters" maxlength="3" style="width:160px;font-size:18px;text-align:center;text-transform:uppercase"/>
          <button class="btn" data-check="t8">Submit</button>
          <button class="btn ghost" data-hint="t8">ğŸ’¡ Hint</button>
        </div>
        <div class="hint" id="t8msg" style="margin-top:8px"></div>
        <div class="token">ğŸ« <b>5</b></div>
      </article>

      <!-- TASK 9 -->
      <article class="panel task-card" data-task="t9" data-token="6">
        <h2>Task 9 â€” Symptom Correlation</h2>
        <p>Match each symptom to the affected stroke:</p>
        <div class="grid" style="grid-template-columns:1.5fr 1fr;gap:12px;align-items:center">
          <div><b>1.</b> Low manifold vacuum at idle</div>
          <select id="t9a"><option>â€”</option><option>Induction</option><option>Compression</option><option>Combustion</option><option>Exhaust</option></select>
          
          <div><b>2.</b> Blue exhaust smoke (oil burning)</div>
          <select id="t9b"><option>â€”</option><option>Induction</option><option>Compression</option><option>Combustion</option><option>Exhaust</option></select>
          
          <div><b>3.</b> Backfire through exhaust system</div>
          <select id="t9c"><option>â€”</option><option>Induction</option><option>Compression</option><option>Combustion</option><option>Exhaust</option></select>
        </div>
        <div class="row" style="margin-top:12px">
          <button class="btn" data-check="t9">Submit</button>
          <button class="btn ghost" data-hint="t9">ğŸ’¡ Hint</button>
        </div>
        <div class="hint" id="t9msg" style="margin-top:8px"></div>
        <div class="token">ğŸ« <b>6</b></div>
      </article>

      <!-- TASK 10 -->
      <article class="panel task-card" data-task="t10" data-token="0">
        <h2>Task 10 â€” Compression Ratio</h2>
        <p>If cylinder volume at BDC is 500cc and TDC is 50cc, what is the compression ratio? (format: X:1)</p>
        <div class="row">
          <input id="t10" placeholder="e.g. 10:1" style="width:160px"/>
          <button class="btn" data-check="t10">Submit</button>
          <button class="btn ghost" data-hint="t10">ğŸ’¡ Hint</button>
        </div>
        <div class="hint" id="t10msg" style="margin-top:8px"></div>
        <div class="token">ğŸ« <b>0</b></div>
      </article>

      <!-- TASK 11 -->
      <article class="panel task-card" data-task="t11" data-token="8">
        <h2>Task 11 â€” Heat Transfer Basics</h2>
        <p>In a vehicle radiator, which <b>mode of heat transfer</b> accounts for most heat loss from fins to the surrounding air?</p>
        <div class="grid" style="gap:8px">
          <label style="padding:10px;background:rgba(255,255,255,.02);border-radius:8px;cursor:pointer" class="radio-label">
            <input type="radio" name="t11" value="Conduction"/> Conduction
          </label>
          <label style="padding:10px;background:rgba(255,255,255,.02);border-radius:8px;cursor:pointer" class="radio-label">
            <input type="radio" name="t11" value="Convection"/> Convection
          </label>
          <label style="padding:10px;background:rgba(255,255,255,.02);border-radius:8px;cursor:pointer" class="radio-label">
            <input type="radio" name="t11" value="Radiation"/> Radiation
          </label>
          <label style="padding:10px;background:rgba(255,255,255,.02);border-radius:8px;cursor:pointer" class="radio-label">
            <input type="radio" name="t11" value="Evaporation"/> Evaporation
          </label>
        </div>
        <div class="row" style="margin-top:12px">
          <button class="btn" data-check="t11">Submit</button>
          <button class="btn ghost" data-hint="t11">ğŸ’¡ Hint</button>
        </div>
        <div class="hint" id="t11msg" style="margin-top:8px"></div>
        <div class="token">ğŸ« <b>8</b></div>
      </article>

      <!-- TASK 12 -->
      <article class="panel task-card" data-task="t12" data-token="3">
        <h2>Task 12 â€” Thermostat Range</h2>
        <p>Enter a <b>typical thermostat opening temperature range</b> in Â°C (e.g., <span class="mono">80-90</span> or <span class="mono">82-88</span>).</p>
        <div class="row">
          <input id="t12" class="mono" placeholder="e.g. 80-90" style="width:180px;text-align:center"/>
          <button class="btn" data-check="t12">Submit</button>
          <button class="btn ghost" data-hint="t12">ğŸ’¡ Hint</button>
        </div>
        <div class="hint" id="t12msg" style="margin-top:8px"></div>
        <div class="token">ğŸ« <b>3</b></div>
      </article>

      <!-- TASK 13 -->
      <article class="panel task-card" data-task="t13" data-token="5">
        <h2>Task 13 â€” The Cycle Riddle</h2>
        <div style="padding:16px;background:rgba(106,227,255,.05);border-left:4px solid var(--accent);border-radius:8px;margin:12px 0">
          <p style="font-style:italic;margin:0;line-height:1.7">
            "First I draw the fuel and air,<br/>
            Then I squeeze them with great care.<br/>
            A spark ignites, I push with might,<br/>
            Finally I clear to start the flight."
          </p>
        </div>
        <p class="tiny">Enter the four stages separated by dashes (e.g. stage1-stage2-stage3-stage4)</p>
        <div class="row">
          <input id="t13" placeholder="stage-stage-stage-stage" style="flex:1;min-width:200px"/>
          <button class="btn" data-check="t13">Submit</button>
          <button class="btn ghost" data-hint="t13">ğŸ’¡ Hint</button>
        </div>
        <div class="hint" id="t13msg" style="margin-top:8px"></div>
        <div class="token">ğŸ« <b>5</b></div>
      </article>

      <!-- TASK 14 -->
      <article class="panel task-card" data-task="t14" data-token="7">
        <h2>Task 14 â€” Identify the Firing Order</h2>
        <p>Watch the animation and select the firing order shown.</p>
        <div style="margin-top:8px;border-radius:10px;overflow:hidden;border:1px solid rgba(255,255,255,.06)">
          <img src="1243firingordergifKaw.gif" alt="Firing order animation" style="width:100%;display:block"/>
        </div>
        <div style="margin-top:12px;display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:8px">
          <label style="padding:10px;background:rgba(255,255,255,.02);border-radius:8px"><input type="radio" name="t14" value="1-3-4-2"/> 1-3-4-2</label>
          <label style="padding:10px;background:rgba(255,255,255,.02);border-radius:8px"><input type="radio" name="t14" value="1-2-3-4"/> 1-2-3-4</label>
          <label style="padding:10px;background:rgba(255,255,255,.02);border-radius:8px"><input type="radio" name="t14" value="1-4-2-3"/> 1-4-2-3</label>
          <label style="padding:10px;background:rgba(255,255,255,.02);border-radius:8px"><input type="radio" name="t14" value="2-4-1-3"/> 2-4-1-3</label>
        </div>
        <div class="row" style="margin-top:12px">
          <button class="btn" data-check="t14">Submit</button>
          <button class="btn ghost" data-hint="t14">ğŸ’¡ Hint</button>
        </div>
        <div class="hint" id="t14msg" style="margin-top:8px"></div>
        <div class="token">ğŸ« <b>7</b></div>
      </article>

      <!-- TASK 15 - LABEL THE DIAGRAM -->
      <article class="panel task-card" data-task="t15" data-token="4" style="grid-column:span 2">
        <h2>Task 15 â€” Decode the Engine's Secret</h2>
        <p>Label all 15 numbered components in the engine diagram. The engine holds a secret messageâ€”take the <b>first letter</b> of each component name in a special sequence to reveal it.</p>
        
        <div class="t15-container">
          <div class="t15-column">
            <div style="font-weight:700;margin-bottom:12px;color:var(--accent)">Left Column</div>
            <label>2: <input id="t15_2"/></label>
            <label>3: <input id="t15_3"/></label>
            <label>4: <input id="t15_4"/></label>
            <label>5: <input id="t15_5"/></label>
            <label>6: <input id="t15_6"/></label>
            <label>7: <input id="t15_7"/></label>
            <label>8: <input id="t15_8"/></label>
            <label>9: <input id="t15_9"/></label>
          </div>
          
          <div class="t15-center">
            <div style="margin-bottom:12px;text-align:center">
              <div style="font-weight:700;margin-bottom:6px;color:var(--accent)">Top Center</div>
              <label style="display:flex;flex-direction:column;gap:4px;align-items:center">
                1: <input id="t15_1" style="width:180px;font-size:14px"/>
              </label>
            </div>
            <div class="t15-diagram">
              <img src="engine-diagram-labeled.webp" alt="Engine cross-section" />
            </div>
            <div class="tiny" style="margin-top:12px;text-align:center;padding:8px;background:rgba(255,255,255,.02);border-radius:8px">
              Match each number to its component name
            </div>
          </div>

          <div class="t15-column">
            <div style="font-weight:700;margin-bottom:12px;color:var(--accent)">Right Column</div>
            <label>10: <input id="t15_10"/></label>
            <label>11: <input id="t15_11"/></label>
            <label>12: <input id="t15_12"/></label>
            <label>13: <input id="t15_13"/></label>
            <label>14: <input id="t15_14"/></label>
            <label>15: <input id="t15_15"/></label>
          </div>
        </div>

        <div style="margin-top:20px;padding:16px;background:rgba(106,227,255,.05);border-left:4px solid var(--accent);border-radius:8px">
          <p style="font-weight:600;margin:0 0 8px 0">ğŸ” Secret Sequence Decoder:</p>
          <p class="tiny" style="margin:0">Once all components are labeled, enter the decoded message from the first letters following this path: <b>7â†’1â†’13â†’4â†’9â†’2â†’15â†’8â†’3â†’11â†’5â†’14â†’6â†’10â†’12</b></p>
        </div>

        <div class="row" style="margin-top:16px;align-items:center;gap:12px">
          <input id="t15code" class="mono" placeholder="15-letter code" maxlength="15" style="flex:1;font-size:18px;text-align:center;text-transform:uppercase;letter-spacing:2px"/>
          <button class="btn" data-check="t15">Decode Message</button>
          <button class="btn ghost" data-hint="t15">ğŸ’¡ Hint</button>
        </div>
        <div class="hint" id="t15msg" style="margin-top:8px"></div>
        <div class="token">ğŸ« <b>4</b></div>
      </article>

    </section>

    <!-- FINAL LOCK WITH RIDDLE -->
    <section class="panel" style="background:linear-gradient(180deg,rgba(255,138,61,.1),rgba(0,0,0,.06))">
      <h2>ğŸ” Final Lock â€” Decode the OTP</h2>
      <p>You've collected 6 OTP digits. But first, solve this riddle to unlock the input:</p>
      <div style="padding:20px;background:rgba(255,255,255,.03);border-radius:12px;margin:16px 0;border:2px dashed rgba(106,227,255,.3)">
        <p style="font-weight:600;color:var(--accent);margin:0 0 12px 0">ğŸ§© RIDDLE:</p>
        <p style="font-style:italic;line-height:1.7;margin:0">
          "The year Otto made history subtract 1800,<br/>
          Then multiply by the strokes we count today,<br/>
          Finally divide by compression's ratio (when 500 meets 50)."
        </p>
      </div>
      <div class="row" style="margin-top:16px">
        <input id="riddleAnswer" type="number" placeholder="Riddle answer" style="width:200px"/>
        <button id="unlockRiddle" class="btn">Solve Riddle</button>
      </div>
      <div id="riddleMsg" class="hint" style="margin-top:8px"></div>
      
      <div id="otpSection" style="display:none;margin-top:24px;padding-top:24px;border-top:2px solid rgba(255,255,255,.1)">
        <p><b>Riddle solved!</b> Now arrange your OTP digits in <b>ascending order</b> and enter the 6-digit code:</p>
        <div class="row" style="margin-top:16px">
          <input id="final" class="mono" placeholder="______" maxlength="6" style="width:220px;font-size:24px;text-align:center;letter-spacing:8px"/>
          <button id="unlock" class="btn" style="font-size:18px;padding:1rem 2rem">ğŸ”“ Unlock Engine</button>
        </div>
        <div id="finalmsg" class="hint" style="margin-top:12px;font-size:16px"></div>
      </div>
    </section>

    <!-- TEACHER CONTROLS WITH PASSWORD -->
    <details class="panel" id="teacherPanel">
      <summary><b>ğŸ‘¨â€ğŸ« Teacher Controls</b></summary>
      <div id="teacherContent" style="display:none">
        <div class="grid" style="gap:16px;margin-top:16px">
          <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:12px">
            <label style="display:grid;gap:4px">
              <b>Winning OTP (ascending order):</b>
              <input id="setOtp" class="mono" value="012345" maxlength="6" style="font-size:18px"/>
            </label>
            <label style="display:grid;gap:4px">
              <b>Riddle Answer:</b>
              <input id="setRiddle" type="number" value="30" style="font-size:18px"/>
            </label>
            <label style="display:grid;gap:4px">
              <b>Task 15 expected code (15 letters):</b>
              <input id="setT15" type="text" value="CVIVCBCCVVCWPC" maxlength="15" style="font-size:18px;text-transform:uppercase"/>
            </label>
          </div>
          <button class="btn secondary" id="reset" style="width:fit-content">ğŸ”„ Reset Game</button>
        </div>
        <p class="tiny" style="margin-top:12px;padding:12px;background:rgba(255,255,255,.02);border-radius:8px">
          <b>Note:</b> OTP digits collected from tokens: 3,7,9,1,8,4,2,5,6,0,8,3,5,7,4. First 6 unique in ascending order: <b>012345</b><br/>
          <b>Riddle:</b> (1876-1800) Ã— 4 Ã· (500/50) = 76 Ã— 4 Ã· 10 = <b>30.4 â†’ 30</b><br/>
          <b>Task 15:</b> Sequence 7â†’1â†’13â†’4â†’9â†’2â†’15â†’8â†’3â†’11â†’5â†’14â†’6â†’10â†’12 should spell the 15-letter code when using first letters of correct component names
        </p>
      </div>
    </details>

  </div>

  <!-- REFERENCE GUIDE DIALOG -->
  <dialog id="guide">
    <div class="grid" style="gap:20px">
      <div style="text-align:center">
        <h2 style="font-size:28px;margin-bottom:12px">ğŸ“– Heat & Cycle Reference</h2>
        <div style="width:60px;height:4px;background:linear-gradient(90deg,var(--accent),var(--good));margin:0 auto;border-radius:999px"></div>
      </div>
      <div style="padding:20px;background:rgba(106,227,255,.05);border:2px solid rgba(106,227,255,.2);border-radius:12px">
        <h3 style="margin-bottom:12px">The Four Strokes:</h3>
        <div style="line-height:2">
          <div><b>1. Induction</b> (Suck) - Air-fuel mixture enters cylinder</div>
          <div><b>2. Compression</b> (Squeeze) - Mixture is compressed</div>
          <div><b>3. Combustion</b> (Bang) - Spark ignites, power generated</div>
          <div><b>4. Exhaust</b> (Blow) - Spent gases expelled</div>
        </div>
      </div>
      <div style="padding:16px;background:rgba(255,255,255,.02);border-radius:10px">
        <h3 style="margin-bottom:8px">ğŸŒ¡ï¸ Heat Transfer in Engines</h3>
        <ul style="margin:8px 0;padding-left:20px;line-height:1.8">
          <li><b>Conduction</b>: Metal-to-metal heat flow (combustion gas â†’ cylinder wall â†’ coolant)</li>
          <li><b>Convection</b>: Fluid movement carries heat (coolant in block; air across radiator fins)</li>
          <li><b>Radiation</b>: Minor but present (hot surfaces emit infrared)</li>
          <li>Most radiator heat loss to air is via <b>forced convection</b> (fan/vehicle speed)</li>
        </ul>
      </div>
      <div style="padding:16px;background:rgba(255,255,255,.02);border-radius:10px">
        <h3 style="margin-bottom:8px">ğŸ”‘ Study Tips</h3>
        <ul style="margin:8px 0;padding-left:20px;line-height:1.8">
          <li>The cycle always follows the same order</li>
          <li>Pair mechanics with thermals: strokes + heat paths</li>
          <li>Wrong answers add 10-second time penalties</li>
        </ul>
      </div>
      <button class="btn" id="closeGuide" style="width:100%;padding:1rem">Return to Challenge</button>
    </div>
  </dialog>

  <!-- PASSWORD DIALOG -->
  <dialog id="passwordDialog">
    <div class="grid" style="gap:20px;min-width:300px">
      <h3>ğŸ”’ Teacher Access</h3>
      <p>Enter teacher password:</p>
      <input type="password" id="teacherPassword" placeholder="Password" style="width:100%"/>
      <div class="row" style="gap:8px">
        <button class="btn" id="submitPassword" style="flex:1">Submit</button>
        <button class="btn ghost" id="cancelPassword" style="flex:1">Cancel</button>
      </div>
      <div id="passwordError" class="hint" style="color:var(--bad)"></div>
    </div>
  </dialog>

  <!-- VIDEO OVERLAY -->
  <div id="videoOverlay">
    <button class="btn ghost" id="closeVideoBtn" type="button">âœ– Close</button>
    <div class="video-box">
      <iframe
        id="videoFrame"
        class="video-frame"
        src=""
        title="YouTube video player"
        allow="autoplay; encrypted-media; picture-in-picture"
        allowfullscreen
      ></iframe>
    </div>
  </div>

  <script>
    // ===== CONFIG =====
    const TEACHER_PASSWORD = "otto1876";
    const PENALTY_SECONDS = 10;
    
    // ===== UTILITIES =====
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));

    // State
    let soundEnabled = true;
    let wrongAnswers = 0;
    let lockoutAttempts = 0;
    let timeOffset = 0;
  let prevSoundEnabled = null;
    const solved = new Set();
    const otpDigits = new Map();

    // Sound effects
    const playSound = (freq, duration) => {
      if (!soundEnabled) return;
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.frequency.value = freq;
        osc.type = 'sine';
        gain.gain.setValueAtTime(0.1, ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + duration);
        osc.start(ctx.currentTime);
        osc.stop(ctx.currentTime + duration);
      } catch(e) {}
    };

    $('#soundToggle').addEventListener('click', () => {
      soundEnabled = !soundEnabled;
      $('#soundToggle').textContent = soundEnabled ? 'ğŸ”Š' : 'ğŸ”‡';
    });

    // Confetti
    const makeConfetti = () => {
      const colors = ['#ff6a7a', '#6ae3ff', '#3de387', '#ffd166', '#ff3b3b', '#30ff6d'];
      for (let i = 0; i < 50; i++) {
        setTimeout(() => {
          const confetti = document.createElement('div');
          confetti.className = 'confetti';
          confetti.style.left = Math.random() * 100 + '%';
          confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
          confetti.style.animationDelay = Math.random() * 0.5 + 's';
          document.body.appendChild(confetti);
          setTimeout(() => confetti.remove(), 3000);
        }, i * 30);
      }
    };

    // Timer with penalties
    let start = Date.now();
    setInterval(() => {
      const elapsed = Math.floor((Date.now() - start) / 1000) + timeOffset;
      const m = String(Math.floor(elapsed / 60)).padStart(2, '0');
      const ss = String(elapsed % 60).padStart(2, '0');
      $('#clock').textContent = `${m}:${ss}`;
      if (timeOffset > 0) {
        $('#timerBadge').style.borderColor = 'var(--warn)';
      }
    }, 1000);

    // Add penalty
    const addPenalty = () => {
      wrongAnswers++;
      timeOffset += PENALTY_SECONDS;
      $('#penalties').textContent = wrongAnswers;
      $('#penaltyBadge').style.display = 'inline-flex';
      playSound(150, 0.3);
    };

    // Show lockout
    const showLockout = (attempts) => {
      const seconds = attempts * 15;
      const overlay = document.createElement('div');
      overlay.className = 'lockout-overlay';
      overlay.innerHTML = `
        <div class="lockout-box">
          <h2 style="color:var(--bad);margin-bottom:20px">ğŸ”’ ACCESS DENIED</h2>
          <p>Due to entering <b>${attempts}</b> incorrect answer(s),<br/>you must wait before trying again.</p>
          <div class="lockout-timer" id="lockoutTimer">${seconds}</div>
          <p class="tiny">Please review your collected digits and try again...</p>
        </div>
      `;
      document.body.appendChild(overlay);
      
      let remaining = seconds;
      const timer = setInterval(() => {
        remaining--;
        $('#lockoutTimer').textContent = remaining;
        if (remaining <= 0) {
          clearInterval(timer);
          overlay.remove();
        }
      }, 1000);
    };

    // Progress
    const updateProgress = () => {
      const total = 15;
      const count = solved.size;
      $('#solved').textContent = `${count}/${total}`;
      $('#bar').style.width = `${(count / total) * 100}%`;

      const order = ['t1','t2','t3','t4','t5','t6','t7','t8','t9','t10','t11','t12','t13','t14','t15'];
      const digits = [];
      const seen = new Set();
      for (const id of order) {
        if (otpDigits.has(id)) {
          const d = otpDigits.get(id);
          if (!seen.has(d) && digits.length < 6) {
            digits.push(d);
            seen.add(d);
          }
        }
      }
      while (digits.length < 6) digits.push('_');
      $('#otp').textContent = digits.join('');
    };

    const award = (taskId, msgEl) => {
      const card = document.querySelector(`[data-task="${taskId}"]`);
      if (!card) return;
      
      solved.add(taskId);
      const digit = card.dataset.token;
      otpDigits.set(taskId, digit);
      
      card.classList.add('solved');
      if (msgEl) {
        msgEl.innerHTML = `<span class="ok">âœ“ Correct! OTP digit: <b>${digit}</b></span>`;
      }
      
      playSound(523.25, 0.1);
      setTimeout(() => playSound(659.25, 0.15), 100);
      
      updateProgress();
    };

    const wrong = (msgEl, text = 'âŒ Incorrect. Try again!', el = null) => {
      addPenalty();
      if (msgEl) {
        msgEl.innerHTML = `<span class="no">${text}</span>`;
      }
      if (el) {
        el.classList.add('error');
        setTimeout(() => el.classList.remove('error'), 300);
      }
    };

    // ===== VIDEO CONTROL (Intro/Outro) =====
    const YT_BASE = 'https://www.youtube.com/embed/zT_UWfxgtfc';
    const openVideo = ({ autoplay = true, mute = true, start = 0 } = {}) => {
      const overlay = $('#videoOverlay');
      const frame = $('#videoFrame');
      if (!overlay || !frame) return;
      // Build URL params
      const p = new URLSearchParams({
        autoplay: autoplay ? '1' : '0',
        mute: mute ? '1' : '0',
        rel: '0',
        modestbranding: '1',
        playsinline: '1',
        start: String(start)
      });
      // Pause app sounds while video plays
      prevSoundEnabled = soundEnabled;
      soundEnabled = false;
      frame.src = `${YT_BASE}?${p.toString()}`;
      overlay.classList.add('open');
      document.body.classList.add('overflow-hidden');
    };
    const closeVideo = () => {
      const overlay = $('#videoOverlay');
      const frame = $('#videoFrame');
      if (frame) frame.src = '';
      overlay?.classList.remove('open');
      document.body.classList.remove('overflow-hidden');
      // Restore app sounds
      if (prevSoundEnabled !== null) {
        soundEnabled = prevSoundEnabled;
        prevSoundEnabled = null;
      }
    };
    $('#closeVideoBtn')?.addEventListener('click', closeVideo);
    // Close when clicking backdrop
    $('#videoOverlay')?.addEventListener('click', (e) => {
      const box = document.querySelector('#videoOverlay .video-box');
      if (!box) return;
      if (!box.contains(e.target)) closeVideo();
    });
    // Close on Escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeVideo();
    });

    // Levenshtein distance for fuzzy matching
    const levenshtein = (a, b) => {
      if (a === b) return 0;
      const al = a.length, bl = b.length;
      if (al === 0) return bl;
      if (bl === 0) return al;
      const matrix = Array.from({length: al + 1}, () => Array(bl + 1).fill(0));
      for (let i = 0; i <= al; i++) matrix[i][0] = i;
      for (let j = 0; j <= bl; j++) matrix[0][j] = j;
      for (let i = 1; i <= al; i++) {
        for (let j = 1; j <= bl; j++) {
          const cost = a[i-1] === b[j-1] ? 0 : 1;
          matrix[i][j] = Math.min(
            matrix[i-1][j] + 1,
            matrix[i][j-1] + 1,
            matrix[i-1][j-1] + cost
          );
        }
      }
      return matrix[al][bl];
    };

    // Canonical labels for Task 15
    const canonicalT15 = [
      'camshaft', 'valve', 'intake', 'valve', 'cylinder', 'block', 'connecting', 'crankshaft', 'valve', 'valve', 'combustion', 'water', 'piston', 'crankcase'
    ];

    const checkers = {
      t1() {
        const a = $('#t1a').value, b = $('#t1b').value, c = $('#t1c').value, d = $('#t1d').value;
        const ok = a === 'Induction' && b === 'Compression' && c === 'Combustion' && d === 'Exhaust';
        ok ? award('t1', $('#t1msg')) : wrong($('#t1msg'), 'âŒ Review the cycle order');
      },
      t2() {
        const ok = $('#t2_1').value === 'D' && $('#t2_2').value === 'C' && $('#t2_3').value === 'B' && $('#t2_4').value === 'A';
        ok ? award('t2', $('#t2msg')) : wrong($('#t2msg'), 'âŒ Consider each component\'s primary role');
      },
      t3() {
        const w = el => el.value.trim().toLowerCase();
        const ok = w($('#t3a')) === 'induction' && w($('#t3b')) === 'compression' && w($('#t3c')) === 'combustion' && w($('#t3d')) === 'exhaust';
        ok ? award('t3', $('#t3msg')) : wrong($('#t3msg'), 'âŒ Check your spelling', $('#t3a'));
      },
      t4() {
        const ok = $('#t4').value.trim() === '1876';
        ok ? award('t4', $('#t4msg')) : wrong($('#t4msg'), 'âŒ Research Otto\'s patent year', $('#t4'));
      },
      t5() {
        const sel = document.querySelector('input[name="t5"]:checked');
        const ok = sel && sel.value === 'Combustion';
        ok ? award('t5', $('#t5msg')) : wrong($('#t5msg'), 'âŒ Which stroke creates power?');
      },
      t6() {
        const v = $('#t6code').value.trim();
        const ok = v === '10';
        ok ? award('t6', $('#t6msg')) : wrong($('#t6msg'), 'âŒ Add all four cylinder numbers', $('#t6code'));
      },
      t7() {
        const ok = $('#t7').value.trim().toUpperCase() === 'SSBB';
        ok ? award('t7', $('#t7msg')) : wrong($('#t7msg'), 'âŒ Take first letter of each word', $('#t7'));
      },
      t8() {
        const val = $('#t8').value.trim().toUpperCase();
        if (!val) return wrong($('#t8msg'), 'âŒ Enter three letters (F/A/R) for the drivetrain layouts', $('#t8'));
        if (val.length !== 3) return wrong($('#t8msg'), 'âŒ Enter exactly three letters', $('#t8'));
        if (!/^[FAR]{3}$/.test(val)) return wrong($('#t8msg'), 'âŒ Use only F, A, or R for each position', $('#t8'));
        
        const expected = 'FAR';
        if (val === expected) {
          award('t8', $('#t8msg'));
        } else {
          wrong($('#t8msg'), 'âŒ Check which wheels are powered in each diagram', $('#t8'));
        }
      },
      t9() {
        const a = $('#t9a').value, b = $('#t9b').value, c = $('#t9c').value;
        const ok = a === 'Induction' && b === 'Compression' && c === 'Exhaust';
        ok ? award('t9', $('#t9msg')) : wrong($('#t9msg'), 'âŒ Consider where each fault originates');
      },
      t10() {
        const v = $('#t10').value.trim();
        const ok = v === '10:1' || v === '10';
        ok ? award('t10', $('#t10msg')) : wrong($('#t10msg'), 'âŒ Divide larger by smaller volume', $('#t10'));
      },
      t11() {
        const sel = document.querySelector('input[name="t11"]:checked');
        const ok = sel && sel.value === 'Convection';
        ok ? award('t11', $('#t11msg')) : wrong($('#t11msg'), 'âŒ Think fluid motion moving heat away from the radiator fins.');
      },
      t12() {
        const raw = ($('#t12').value || '').trim();
        if (!raw) return wrong($('#t12msg'), 'âŒ Enter a range like 80-90 Â°C', $('#t12'));
        const normalized = raw
          .replace(/\s+/g,'')
          .replace(/[â€“â€”]/g,'-')
          .replace(/to/i,'-');
        const m = normalized.match(/^(\d{2,3})-(\d{2,3})$/);
        if (!m) return wrong($('#t12msg'), 'âŒ Use a hyphenated range, e.g., 80-90', $('#t12'));
        const a = parseInt(m[1],10), b = parseInt(m[2],10);
        if (!(a < b)) return wrong($('#t12msg'), 'âŒ The first value should be lower than the second', $('#t12'));
        // Accept ranges fully within 80â€“90Â°C inclusive
        const inside = (x) => x >= 80 && x <= 90;
        const ok = inside(a) && inside(b);
        ok ? award('t12', $('#t12msg')) : wrong($('#t12msg'), 'âŒ Typical thermostat range is around 80â€“90Â°C', $('#t12'));
      },
      t13() {
        const v = $('#t13').value.trim().toLowerCase().replace(/\s+/g, '');
        const ok = v === 'induction-compression-combustion-exhaust' || v === 'suck-squeeze-bang-blow';
        ok ? award('t13', $('#t13msg')) : wrong($('#t13msg'), 'âŒ Follow the riddle\'s sequence', $('#t13'));
      },
      t14() {
        const sel = document.querySelector('input[name="t14"]:checked');
        const ok = sel && sel.value === '1-3-4-2';
        ok ? award('t14', $('#t14msg')) : wrong($('#t14msg'), 'âŒ That firing order is not shown', null);
      },
      t15() {
        const sequence = [7,1,13,4,9,2,15,8,3,11,5,14,6,10,12];
        const ids = Array.from({length: 15}, (_, i) => `t15_${i+1}`);
        const vals = ids.map(id => ($('#' + id).value || '').trim());
        const enteredCode = ($('#t15code').value || '').trim().toUpperCase();
        const teacherCode = $('#setT15').value.trim().toUpperCase();
        
        if (!enteredCode) {
          return wrong($('#t15msg'), 'âŒ Enter the decoded message from the first letters', $('#t15code'));
        }
        
        if (enteredCode.length !== 15) {
          return wrong($('#t15msg'), 'âŒ The code must be exactly 15 letters', $('#t15code'));
        }
        
        if (vals.some(v => !v)) {
          return wrong($('#t15msg'), 'âŒ Please label all 15 components first', $('#' + ids.find(id => !$('#' + id).value)));
        }

        const letters = sequence.map(i => vals[i-1][0].toUpperCase()).join('');
        
        if (enteredCode !== letters) {
          return wrong($('#t15msg'), `âŒ Your code doesn't match the sequence. Following 7â†’1â†’13â†’... gives: <b>${letters}</b>`, $('#t15code'));
        }
        
        const lowerVals = vals.map(v => v.toLowerCase());
        let allClose = true;
        for (let i = 0; i < canonicalT15.length; i++) {
          const a = lowerVals[i] || '';
          const b = canonicalT15[i] || '';
          const dist = levenshtein(a, b);
          const threshold = Math.ceil(Math.max(a.length, b.length) * 0.25);
          if (dist > threshold) { allClose = false; break; }
        }

        if (allClose && enteredCode === teacherCode) {
          $('#t15msg').innerHTML = `<span class="ok">âœ“ Perfect! Components labeled correctly and message decoded: <b>${letters}</b></span>`;
          ids.forEach(id => { 
            const el = $('#' + id); 
            el.classList.add('input-ok'); 
            el.disabled = true; 
          });
          $('#t15code').classList.add('input-ok');
          $('#t15code').disabled = true;
          return award('t15', null);
        } else if (!allClose) {
          return wrong($('#t15msg'), `âŒ Some component labels need correction. Your sequence spells: <b>${letters}</b>`, $('#t15code'));
        } else {
          return wrong($('#t15msg'), `âŒ Message decoded as <b>${letters}</b> but doesn't match the engine's secret`, $('#t15code'));
        }
      }
    };
    
    // Wire buttons
    $$('[data-check]').forEach(btn => btn.addEventListener('click', () => {
      const id = btn.getAttribute('data-check');
      checkers[id] && checkers[id]();
    }));

    // Hints
    const hints = {
      t1: 'ğŸ’¡ First comes the breath of life, then muscles flex, followed by explosive power, ending with a cleansing sigh...',
      t2: 'ğŸ’¡ What moves up and down becomes round and round, gates guide the flow, while sparks ignite the show...',
      t3: 'ğŸ’¡ The words you seek share a common end, in the cycle\'s order your path will bend...',
      t4: 'ğŸ’¡ A century after freedom\'s bell, this year holds secrets to tell...',
      t5: 'ğŸ’¡ When sparks fail to dance, this ghost appears by chance...',
      t6: 'ğŸ’¡ Four numbers in line, their sum divine...',
      t7: 'ğŸ’¡ Two sucks, two bangs, in letters they dance...',
      t8: 'ğŸ’¡ Some cars pull from the front, others push from behind, the ambitious ones use all their feet...',
      t9: 'ğŸ’¡ Air whispers of hunger, oil leaves its trace, timing\'s dance sets the pace...',
      t10: 'ğŸ’¡ When space is squeezed from max to min, this ratio holds the secret within...',
  t11: 'ğŸ’¡ Fins donâ€™t glow heat awayâ€”they hand it to moving air. Which mode moves heat with the flow?',
  t12: 'ğŸ’¡ Most road cars begin opening the thermostat roughly in the low-to-high 80s Â°Câ€¦',
      t13: 'ğŸ’¡ In verses four, the engine\'s lore...',
      t14: 'ğŸ’¡ Like dancers in time, cylinders chime...',
      t15: 'ğŸ’¡ Name the parts from heart to shell, follow the path where numbers tell, each letter\'s start reveals the spell...'
    };

    $$('[data-hint]').forEach(btn => btn.addEventListener('click', () => {
      const id = btn.getAttribute('data-hint');
      const msg = $(`#${id}msg`);
      if (msg) msg.textContent = hints[id] || 'ğŸ’¡ No hint available';
    }));

    // Guide dialog
    $('#openGuide').onclick = () => $('#guide').showModal();
    $('#closeGuide').onclick = () => $('#guide').close();

    // Riddle unlock
    $('#unlockRiddle').addEventListener('click', () => {
      const answer = parseInt($('#riddleAnswer').value);
      const correct = parseInt($('#setRiddle').value);
      if (answer === correct) {
        $('#riddleMsg').innerHTML = '<span class="ok">âœ“ Riddle solved! OTP input unlocked.</span>';
        $('#otpSection').style.display = 'block';
        playSound(659.25, 0.2);
      } else {
        addPenalty();
        $('#riddleMsg').innerHTML = '<span class="no">âŒ Incorrect. Review the riddle calculations.</span>';
        $('#riddleAnswer').classList.add('error');
        setTimeout(() => $('#riddleAnswer').classList.remove('error'), 300);
      }
    });

    // Final unlock
    $('#unlock').addEventListener('click', () => {
      const expected = $('#setOtp').value.trim();
      const given = $('#final').value.trim();
      const out = $('#finalmsg');
      
      if (given === expected) {
        out.innerHTML = '<span class="ok" style="font-size:20px">ğŸ‰ ENGINE REPAIRED! Mission Complete! ğŸ†</span>';
        makeConfetti();
        playSound(523.25, 0.15);
        setTimeout(() => playSound(659.25, 0.15), 150);
        setTimeout(() => playSound(783.99, 0.3), 300);
        // Show celebratory video after success (attempt autoplay with sound)
        setTimeout(() => openVideo({ autoplay: true, mute: false, title: 'Mission Complete â€” Replay' }), 400);
      } else {
        lockoutAttempts++;
        addPenalty();
        out.innerHTML = `<span class="no">âŒ Incorrect code. Check digit order!</span>`;
        $('#final').classList.add('error');
        setTimeout(() => $('#final').classList.remove('error'), 300);
        showLockout(lockoutAttempts);
      }
    });

    // Teacher password
    let teacherUnlocked = false;
    $('#teacherPanel').addEventListener('toggle', (e) => {
      if (e.target.open && !teacherUnlocked) {
        e.preventDefault();
        $('#teacherPanel').removeAttribute('open');
        $('#passwordDialog').showModal();
      }
    });

    $('#submitPassword').addEventListener('click', () => {
      if ($('#teacherPassword').value === TEACHER_PASSWORD) {
        teacherUnlocked = true;
        $('#passwordDialog').close();
        $('#teacherContent').style.display = 'block';
        $('#teacherPanel').setAttribute('open', '');
        $('#teacherPassword').value = '';
        $('#passwordError').textContent = '';
      } else {
        $('#passwordError').textContent = 'âŒ Incorrect password';
        $('#teacherPassword').classList.add('error');
        setTimeout(() => $('#teacherPassword').classList.remove('error'), 300);
      }
    });

    $('#cancelPassword').addEventListener('click', () => {
      $('#passwordDialog').close();
      $('#teacherPassword').value = '';
      $('#passwordError').textContent = '';
    });

    // Reset
    $('#reset').addEventListener('click', () => {
      if (confirm('Reset the entire game? All progress will be lost.')) {
        location.reload();
      }
    });

    // Radio hover
    $$('.radio-label').forEach(label => {
      label.addEventListener('mouseenter', () => label.style.background = 'rgba(106,227,255,.08)');
      label.addEventListener('mouseleave', () => label.style.background = 'rgba(255,255,255,.02)');
    });

    updateProgress();

    // Show intro video on load (autoplay muted for compatibility)
    window.addEventListener('load', () => {
      // Delay slightly to ensure layout stable
      setTimeout(() => openVideo({ autoplay: true, mute: false, title: 'Introduction â€” Engine Escape' }), 300);
    });
  </script>
</body>
</html>
